<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>webhook.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Admin.html">Admin</a><ul class='methods'><li data-type='method'><a href="Admin.html#list">list</a></li></ul></li><li><a href="Auth.html">Auth</a><ul class='methods'><li data-type='method'><a href="Auth.html#init">init</a></li><li data-type='method'><a href="Auth.html#koa">koa</a></li><li data-type='method'><a href="Auth.html#signInFirebaseTemplate">signInFirebaseTemplate</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#utilities">utilities</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">webhook.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const Debug = require('debug');                 // https://github.com/visionmedia/debug
const utilities = require(__dirname + '/utilities.js');

let webhook = {
  debug: new Debug('shopify-server:webhook'),
};

/**
 * All avaiable webhook topics
 * @see https://help.shopify.com/api/reference/webhook
 */
webhook.topics = [
  'carts/create',
  'carts/update',
  'checkouts/create',
  'checkouts/delete',
  'checkouts/update',
  'collections/create',
  'collections/delete',
  'collections/update',
  'collection_listings/add',
  'collection_listings/remove',
  'collection_listings/update',
  'customers/create',
  'customers/delete',
  'customers/disable',
  'customers/enable',
  'customers/update',
  'customer_groups/create',
  'customer_groups/delete',
  'customer_groups/update',
  'draft_orders/create',
  'draft_orders/delete',
  'draft_orders/update',
  'fulfillments/create',
  'fulfillments/update',
  'fulfillment_events/create',
  'fulfillment_events/delete',
  'orders/cancelled',
  'orders/create',
  'orders/delete',
  'orders/fulfilled',
  'orders/paid',
  'orders/partially_fulfilled',
  'orders/updated',
  'order_transactions/create',
  'products/create',
  'products/delete',
  'products/update',
  'product_listings/add',
  'product_listings/remove',
  'product_listings/update',
  'refunds/create',
  'app/uninstalled',
  'shop/update',
  'themes/create',
  'themes/delete',
  'themes/publish',
  'themes/update',
];

/**
 * Subscripe all webhooks defined in opts.topics, if opts.topics is not defined, all webhooks will be subscriped
 * @param {Object} opts Options
 * @param {Array} shops
 * @return {Promise}
 */
webhook.subscripe = (opts, shops) => {
  webhook.debug('subscripe webhooks', 'options', opts);

  if(opts === null || typeof(opts) !== 'object') {
    opts = {};
  }

  if(typeof(opts.appName) !== 'string') {
    throw new Error('app name string is required');
  }

  if(typeof(opts.address) !== 'string') {
    throw new Error('address string is required');
  }

  if(!utilities.isArray(shops)) {
    throw new Error('shops array is required');
  }

  if(!utilities.isArray(opts.topics)) {
    opts.topics = webhook.topics;
  }

  let createWebhooks = [];

  /**
   * Prepair webhooks fpr create / update
   */
  for (let g = 0; g &lt; opts.topics.length; g++) {
    const topic = opts.topics[g];
    const routeURL = `/webhook/${opts.appName}/${topic}`;
    const webhookUrl = `${opts.address}${routeURL}`;

    const params = {
      'topic': topic,
      'address': webhookUrl,
      'format': 'json',
    };

    let needSalesChannelSDK = false;
    if(topic === 'collection_listings/remove'
    || topic === 'collection_listings/update'
    || topic === 'collection_listings/add'
    || topic === 'product_listings/add'
    || topic === 'product_listings/update'
    || topic === 'product_listings/remove') {
      needSalesChannelSDK = true;
    }

    createWebhooks.push({
      needUpdate: false,
      needSalesChannelSDK: needSalesChannelSDK,
      params: params,
    });
  }

  /*
   * Get all webhooks for all shops and check if topics need an update or an creation
   */

};

/**
 * Koa middleware for shopify webhooks
 * Create routes to resive webhooks defined in opts.topics.
 * If opts.topics is not defined, this middleware will create routes for all webhooks.
 * @requires koa-router
 * @param {Object} opts
 * @param {Object} app
 * @param {Array} shops
 * @param {Object} controller
 * @return {Object} router
 */
webhook.koa = (opts, app, shops, controller) => {
  const Router = require('koa-router'); // https://github.com/alexmingoia/koa-router/tree/master/
  const router = new Router();

  webhook.debug('init koa middleware', 'options', opts);

  if(opts === null || typeof(opts) !== 'object') {
    opts = {};
  }

  if(typeof(opts.appName) !== 'string') {
    throw new Error('app name string is required');
  }

  if(typeof(opts.address) !== 'string') {
    throw new Error('address string is required');
  }

  if(typeof(controller) === 'undefined') {
    throw new Error('controller object is required');
  }

  if(typeof(opts.baseUrl) !== 'string') {
    opts.baseUrl = `/webhook/${opts.appName}`;
  }

  if(!utilities.isArray(opts.topics)) {
    opts.topics = webhook.topics;
  }

  for (let i = 0; i &lt; opts.topics.length; i++) {
    const topic = opts.topics[i];
    const tmp = topic.split('/');
    const ressource = tmp[0];
    const action = tmp[1];
    const routeURL = `/webhook/${opts.appName}/${topic}`;
    webhook.debug(`init route: ${routeURL}`, ressource, action);
    /**
     * Route to recive the webhook
     */
    router.post(routeURL, controller[ressource][action]);
  }
  return router;
};

module.exports = webhook;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Tue May 02 2017 18:16:11 GMT+0200 (CEST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
